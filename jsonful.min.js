(function(){var t,e,n,r,s,o,i,u,c,h,l=[].slice,f={}.hasOwnProperty,p=function(t,e){function n(){this.constructor=t}for(var r in e)f.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=function(){function t(){this.events={}}return t.prototype.emit=function(){var t,e,n,r,s,o;if(e=arguments[0],t=2<=arguments.length?l.call(arguments,1):[],!this.events[e])return!1;for(o=this.events[e],n=0,r=o.length;r>n;n++)s=o[n],s.apply(null,t);return!0},t.prototype.addListener=function(t,e){var n;return this.emit("newListener",t,e),(null!=(n=this.events)[t]?n[t]:n[t]=[]).push(e),this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(t,e){var n;return n=function(r){return function(){return r.removeListener(t,n),e.apply(null,arguments)}}(this),this.on(t,n),this},t.prototype.removeListener=function(t,e){var n;return this.events[t]?(this.events[t]=function(){var r,s,o,i;for(o=this.events[t],i=[],r=0,s=o.length;s>r;r++)n=o[r],n!==e&&i.push(n);return i}.call(this),this):this},t.prototype.removeAllListeners=function(t){return delete this.events[t],this},t}(),u={},h=setTimeout,i=function(t,e){var n,r;for(n in e)f.call(e,n)&&(r=e[n],t[n]=r);return t},e=function(t){function e(t){this.server=t,this._queue=[],this._headers={},this._callback=this._sendRequest.bind(this),e.__super__.constructor.call(this),this.on("session",function(t){return this._headers.session=t}.bind(this))}return p(e,t),e.prototype._xhrRequest=function(t,n){var r;return r=e.getXhr(),r.onload=n,r.onerror=function(){return console.error(r.responseText)},r.open("POST",this.server,!0),r.responseType="json",r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(i({requests:t},this._headers)))},e.prototype.handle_responses=function(t,e){var n,r,s;r=[];for(n in t)f.call(t,n)&&(s=t[n],"object"==typeof s&&s.error?r.push(e[n].failure(s)):r.push(e[n].success(s)));return r},e.prototype._sendRequest=function(){var t,e,n;return t=this._queue,e=t.map(function(t){return[t.name,t.args]}),n=this,this._xhrRequest(e,function(){var r,s,o,i;if(s=this.response||"string"!=typeof this.responseText?this.response:JSON.parse(this.responseText),!(s&&s instanceof Object&&s.responses instanceof Array))return void n.emit("error",new Error("Invalid response from the server"),e);o=[];for(r in s)f.call(s,r)&&(i=s[r],"function"==typeof n["handle_"+r]?o.push(n["handle_"+r](i,t)):o.push(n.emit(r,i)));return o}),this._queue=[]},e.prototype.setSession=function(t){return this._headers.session=t,this},e.prototype.exec=function(t,e,r){var s;return null==e&&(e=[]),null==r&&(r=null),"function"==typeof e&&(r=e,e=[]),s=new n(function(n,r){return this._queue.push({name:t,args:e,success:n,failure:r})}.bind(this)),"function"==typeof r&&(s.then(function(t){return r(null,t)}),s["catch"](function(t){return r(t,null)})),clearTimeout(this._sender),this._sender=setTimeout(this._callback),s},e}(t),e.getXhr=function(){return new XMLHttpRequest},this.JSONful=e,this.Promise=n,this.EventEmitter=t,c=Array.prototype.push,o=function(t){return"function"==typeof t},s=function(t){return t},r=function(t){throw t},u.exports=n=function(){function t(t){var e,n,r,s;this._reactions=[],s=this._resolve(!0),r=this._resolve(!1);try{t(s,r)}catch(n){e=n,r(e)}}return t.prototype.then=function(t,e){return o(t)||(t=s),o(e)||(e=r),new this.constructor(function(n){return function(r,s){var o;return(o=n._settled?h:c.bind(n._reactions))(function(){var o,i,u,c;o=n._success?t:e;try{c=o(n._result)}catch(u){return i=u,s(i)}return r(c)})}}(this))},t.prototype["catch"]=function(t){return this.then(null,t)},t.prototype._resolve=function(t){return function(e){return function(n){var r,s,o,i;if(!e._resolved){if(e._resolved=!0,t){if(n===e)return i=new TypeError("can't resolve a promise with itself"),e._settle(!1,i);try{o=e.constructor._normalizeThenable(n)}catch(s){return r=s,e._settle(!1,r)}if(o)return void o.then(function(t){return e._settle(!0,t)},function(t){return e._settle(!1,t)})}return e._settle(t,n)}}}(this)},t.prototype._settle=function(t,e){var n,r,s,o;if(!this._settled){for(this._settled=!0,this._success=t,this._result=e,o=this._reactions,n=0,r=o.length;r>n;n++)s=o[n],h(s);return this._reactions=null}},t.resolve=function(t){var e,n,r;try{r=this._normalizeThenable(t)}catch(n){return e=n,this.reject(e)}return r||new this(function(e,n){return e(t)})},t.reject=function(t){return new this(function(e,n){return n(t)})},t._normalizeThenable=function(t){var e,n;return n=null!=t?t.then:void 0,o(n)?t instanceof this?t:"boolean"==(e=typeof t)||"number"===e?!1:new this(function(e,r){return n.call(t,e,r)}):!1},t}()}).call(this);